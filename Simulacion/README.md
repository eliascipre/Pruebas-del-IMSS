# üìã Documentaci√≥n Completa del Proyecto - Simulaci√≥n de Entrevista Pre-visita MedGemma

## üìñ √çndice
1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Componentes Principales](#componentes-principales)
4. [Flujo de Trabajo](#flujo-de-trabajo)
5. [Modelos de IA Utilizados](#modelos-de-ia-utilizados)
6. [Configuraci√≥n y Despliegue](#configuraci√≥n-y-despliegue)
7. [Traducci√≥n al Espa√±ol](#traducci√≥n-al-espa√±ol)
8. [Estructura de Archivos](#estructura-de-archivos)

---

## üìù Descripci√≥n General

**AppointReady** es una aplicaci√≥n de demostraci√≥n que simula entrevistas m√©dicas pre-visita utilizando el modelo MedGemma de Google. El sistema simula una conversaci√≥n entre un asistente m√©dico de IA (MedGemma) y un paciente virtual (Gemini) para recopilar informaci√≥n m√©dica relevante y generar informes cl√≠nicos estructurados.

### Caracter√≠sticas Principales:
- ‚úÖ Entrevistas m√©dicas simuladas en tiempo real
- ‚úÖ Generaci√≥n autom√°tica de reportes cl√≠nicos
- ‚úÖ S√≠ntesis de voz con Gemini TTS
- ‚úÖ Evaluaci√≥n autom√°tica de la calidad del reporte
- ‚úÖ Integraci√≥n con registros FHIR (Fast Healthcare Interoperability Resources)
- ‚úÖ Sistema de cach√© persistente para optimizaci√≥n
- ‚úÖ Interfaz completamente en espa√±ol

---

## üèóÔ∏è Arquitectura del Sistema

### Diagrama de Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USUARIO                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              FRONTEND (React)                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ WelcomePage ‚îÇ Patient    ‚îÇ Interview            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ Builder    ‚îÇ Component            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ HTTP/EventStream
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              BACKEND (Flask/Python)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  app.py (Servidor Principal)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ /api/stream_conversation                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ /api/evaluate_report                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ /api/download_cache                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                    ‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  interview_simulator.py                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ patient_roleplay_instructions()             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ interviewer_roleplay_instructions()         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ report_writer_instructions()                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ stream_interview()                          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ               ‚îÇ               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇMedGemma‚îÇ    ‚îÇ  Gemini  ‚îÇ    ‚îÇGemini TTS‚îÇ
‚îÇ 27B    ‚îÇ    ‚îÇ2.5 Flash ‚îÇ    ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes por Capas

#### **1. Capa de Presentaci√≥n (Frontend - React)**
- **WelcomePage**: P√°gina de bienvenida con informaci√≥n del demo
- **PatientBuilder**: Selecci√≥n de paciente y condici√≥n m√©dica
- **RolePlayDialogs**: Explicaci√≥n del proceso de simulaci√≥n  
- **Interview**: Interfaz principal de entrevista con chat y reporte en tiempo real
- **DetailsPopup**: Informaci√≥n t√©cnica del demo

#### **2. Capa de Aplicaci√≥n (Backend - Flask)**
- **app.py**: Servidor principal con endpoints REST
  - `GET /api/stream_conversation`: Streaming de la entrevista
  - `POST /api/evaluate_report`: Evaluaci√≥n del reporte
  - `GET /api/download_cache`: Descarga del cach√©
  
- **interview_simulator.py**: L√≥gica principal de simulaci√≥n
  - Gesti√≥n del di√°logo entre entrevistador y paciente
  - Generaci√≥n incremental de reportes
  - Integraci√≥n con TTS

- **evaluation.py**: Evaluaci√≥n de calidad de reportes
- **cache.py**: Sistema de cach√© persistente con diskcache

#### **3. Capa de Integraci√≥n (Clientes de IA)**
- **medgemma.py**: Cliente para MedGemma (Vertex AI)
- **gemini.py**: Cliente para Gemini API
- **gemini_tts.py**: Cliente para s√≠ntesis de voz
- **local_llm_client.py**: Cliente para modelos locales (opcional)

#### **4. Capa de Datos**
- **symptoms.json**: Base de datos de s√≠ntomas por condici√≥n
- **patients_and_conditions.json**: Informaci√≥n de pacientes y condiciones
- **report_template.txt**: Plantilla de reportes m√©dicos
- **Archivos FHIR JSON**: Registros m√©dicos sint√©ticos

---

## üß© Componentes Principales

### Backend Components

#### **1. interview_simulator.py**
N√∫cleo del sistema de simulaci√≥n.

**Funciones Principales:**

```python
def patient_roleplay_instructions(patient_name, condition_name, previous_answers):
    """
    Genera instrucciones para que el LLM act√∫e como paciente.
    Incluye:
    - Persona del paciente (nombre, edad, g√©nero)
    - Escenario cl√≠nico
    - S√≠ntomas espec√≠ficos de la condici√≥n
    - Reglas de actuaci√≥n
    """

def interviewer_roleplay_instructions(patient_name):
    """
    Genera instrucciones para que MedGemma act√∫e como entrevistador.
    Incluye:
    - Objetivo cl√≠nico
    - Estrategia de entrevista
    - L√≠mites y restricciones
    - Acceso a EHR del paciente
    """

def report_writer_instructions(patient_name):
    """
    Genera instrucciones para redacci√≥n de reportes m√©dicos.
    Incluye:
    - Principios de brevedad y relevancia cl√≠nica
    - Formato estructurado (HPI, historia m√©dica, medicamentos)
    - Integraci√≥n con datos del EHR
    """

def stream_interview(patient_name, condition_name):
    """
    Funci√≥n principal que orquesta la entrevista completa:
    1. Inicializa el di√°logo
    2. MedGemma hace preguntas
    3. Gemini responde como paciente
    4. Genera audio con TTS
    5. Actualiza el reporte en tiempo real
    6. Yields JSON con cada mensaje
    """
```

#### **2. app.py**
Servidor Flask con endpoints RESTful.

```python
# Endpoint principal - Streaming de entrevista
@app.route("/api/stream_conversation", methods=["GET"])
def stream_conversation():
    """
    Server-Sent Events (SSE) para streaming en tiempo real.
    Par√°metros:
    - patient: Nombre del paciente
    - condition: Condici√≥n m√©dica a simular
    
    Retorna: Stream de mensajes JSON
    """

# Endpoint de evaluaci√≥n
@app.route("/api/evaluate_report", methods=["POST"])
def evaluate_report_call():
    """
    Eval√∫a la calidad del reporte generado.
    Body: { "report": "...", "condition": "..." }
    
    Retorna: { "evaluation": "HTML con evaluaci√≥n" }
    """
```

#### **3. cache.py**
Sistema de cach√© persistente para reducir llamadas a APIs.

```python
from diskcache import Cache

cache = Cache("./cache")

@cache.memoize()  # Decorator para cachear funciones
def medgemma_get_text_response(...):
    # Llamada a API cacheada autom√°ticamente
    pass
```

### Frontend Components

#### **1. Interview.js**
Componente principal de la interfaz de entrevista.

**Caracter√≠sticas:**
- Manejo de Server-Sent Events (SSE) para streaming
- Cola de mensajes con procesamiento secuencial
- Reproducci√≥n autom√°tica de audio
- Generaci√≥n de diff visual del reporte en tiempo real
- Control de velocidad de reproducci√≥n

```javascript
// Procesamiento de cola de mensajes
const processQueue = () => {
  if (messageQueue.current.length === 0) return;
  const nextMessage = messageQueue.current.shift();
  
  setMessages(prev => [...prev, nextMessage]);
  
  if (nextMessage.audio && isAudioEnabled) {
    const audio = new Audio(nextMessage.audio);
    audio.onended = () => processQueue();
    audio.play();
  } else {
    setTimeout(processQueue, waitTime);
  }
};
```

#### **2. PatientBuilder.js**
Interfaz de selecci√≥n de paciente y condici√≥n.

**Caracter√≠sticas:**
- Selecci√≥n visual de pacientes con videos
- Filtrado de condiciones seg√∫n paciente
- Visualizaci√≥n de registros FHIR
- Validaci√≥n antes de iniciar simulaci√≥n

---

## üîÑ Flujo de Trabajo

### Flujo Completo de la Aplicaci√≥n

```
1. BIENVENIDA
   ‚îÇ
   ‚îú‚îÄ> Usuario lee descripci√≥n del demo
   ‚îî‚îÄ> Clic en "Seleccionar Paciente"
   
2. SELECCI√ìN
   ‚îÇ
   ‚îú‚îÄ> Usuario selecciona paciente (Jordon, Alex, Sacha)
   ‚îú‚îÄ> Usuario selecciona condici√≥n (Gripe, Malaria, Migra√±a, S√≠ndrome Serotonina)
   ‚îî‚îÄ> Clic en "Lanzar simulaci√≥n"

3. SIMULACI√ìN DE ENTREVISTA
   ‚îÇ
   ‚îú‚îÄ> Backend inicia stream con SSE
   ‚îÇ   ‚îÇ
   ‚îÇ   ‚îú‚îÄ> MedGemma (Entrevistador)
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Lee EHR del paciente
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Genera pregunta cl√≠nica
   ‚îÇ   ‚îÇ   ‚îî‚îÄ Sintetiza audio (TTS)
   ‚îÇ   ‚îÇ
   ‚îÇ   ‚îú‚îÄ> Gemini (Paciente)
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Lee s√≠ntomas de condition
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Genera respuesta natural
   ‚îÇ   ‚îÇ   ‚îî‚îÄ Sintetiza audio (TTS)
   ‚îÇ   ‚îÇ
   ‚îÇ   ‚îú‚îÄ> Actualizaci√≥n de Reporte
   ‚îÇ   ‚îÇ   ‚îú‚îÄ MedGemma procesa Q&A
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Actualiza secciones del reporte
   ‚îÇ   ‚îÇ   ‚îî‚îÄ Frontend muestra diff visual
   ‚îÇ   ‚îÇ
   ‚îÇ   ‚îî‚îÄ> Repetir hasta 20 preguntas o "Terminar entrevista"
   ‚îÇ
   ‚îî‚îÄ> Entrevista completa

4. EVALUACI√ìN
   ‚îÇ
   ‚îú‚îÄ> Usuario clic en "Ver Evaluaci√≥n del Reporte"
   ‚îú‚îÄ> MedGemma recibe diagn√≥stico de referencia
   ‚îú‚îÄ> Genera autoevaluaci√≥n (fortalezas y mejoras)
   ‚îî‚îÄ> Muestra resultados en HTML
```

### Flujo de Datos Detallado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   INICIAR ENTREVISTA                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend: EventSource("/api/stream_conversation?...")   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend: stream_interview(patient, condition)           ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  Loop (hasta 20 preguntas):                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ 1. MedGemma genera pregunta                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Revisa contexto EHR                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Considera respuestas previas               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Aplica estrategia cl√≠nica                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 2. S√≠ntesis de audio (opcional)                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Gemini TTS genera audio                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Convierte a MP3                            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Codifica en base64                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 3. Enviar a frontend                            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    yield {speaker: "interviewer", text, audio}  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 4. Gemini genera respuesta como paciente       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Lee s√≠ntomas de la condici√≥n               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Responde naturalmente                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Mantiene consistencia                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 5. S√≠ntesis de audio paciente                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 6. Enviar a frontend                            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    yield {speaker: "patient", text, audio}      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 7. Actualizar reporte                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - MedGemma sintetiza Q&A                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Actualiza secciones relevantes             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    - Mantiene formato Markdown                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 8. Enviar reporte actualizado                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ    yield {speaker: "report", text: markdown}    ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend: Procesar mensajes secuencialmente            ‚îÇ
‚îÇ  - Agregar a cola                                        ‚îÇ
‚îÇ  - Reproducir audio si est√° disponible                   ‚îÇ
‚îÇ  - Mostrar en interfaz                                   ‚îÇ
‚îÇ  - Calcular diff para reporte                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ü§ñ Modelos de IA Utilizados

### 1. **MedGemma 27B (Text-IT)**
- **Rol**: Asistente cl√≠nico entrevistador y redactor de reportes
- **Proveedor**: Google Health AI
- **Despliegue**: Vertex AI Model Garden
- **Caracter√≠sticas**:
  - Especializado en tareas m√©dicas
  - Conocimiento de terminolog√≠a cl√≠nica
  - Capacidad de razonamiento cl√≠nico
  - Generaci√≥n de documentaci√≥n m√©dica estructurada

**Uso en el Sistema:**
```python
# Como entrevistador
messages = [
    {"role": "system", "content": interviewer_roleplay_instructions(patient)},
    {"role": "user", "content": "Iniciar entrevista"}
]
question = medgemma_get_text_response(messages)

# Como redactor
messages = [
    {"role": "system", "content": report_writer_instructions(patient)},
    {"role": "user", "content": interview_transcript}
]
report = medgemma_get_text_response(messages)

# Como evaluador
messages = [
    {"role": "system", "content": evaluation_prompt(condition)},
    {"role": "user", "content": report}
]
evaluation = medgemma_get_text_response(messages)
```

### 2. **Gemini 2.5 Flash**
- **Rol**: Paciente virtual
- **Proveedor**: Google AI
- **API**: Gemini API (generativelanguage.googleapis.com)
- **Caracter√≠sticas**:
  - Respuestas r√°pidas y naturales
  - Comprensi√≥n contextual excelente
  - Capacidad multimodal

**Uso en el Sistema:**
```python
prompt = f"""
{patient_roleplay_instructions(patient, condition, previous_answers)}

Pregunta: {interviewer_question}
"""
response = gemini_get_text_response(prompt)
```

### 3. **Gemini TTS (Text-to-Speech)**
- **Rol**: S√≠ntesis de voz
- **Modelo**: gemini-2.5-flash-preview-tts
- **Caracter√≠sticas**:
  - Voces naturales y expresivas
  - Configuraci√≥n de tono y velocidad
  - Soporte de m√∫ltiples idiomas
  - Salida en formato MP3

**Configuraci√≥n de Voces:**
```python
INTERVIEWER_VOICE = "Aoede"  # Voz profesional

# Voces por paciente
"Jordon Dubois": "Algenib"
"Alex Sharma": "Gacrux"
"Sacha Silva": "Callirrhoe"
```

**S√≠ntesis de Audio:**
```python
def synthesize_gemini_tts(text, voice_name):
    generation_config = {
        "response_modalities": ["AUDIO"],
        "speech_config": {
            "voice_config": {
                "prebuilt_voice_config": {
                    "voice_name": voice_name
                }
            }
        }
    }
    response = model.generate_content(text, generation_config)
    audio_data = response.candidates[0].content.parts[0].inline_data.data
    # Convertir a MP3 y retornar
    return mp3_data, "audio/mpeg"
```

---

## ‚öôÔ∏è Configuraci√≥n y Despliegue

### Requisitos del Sistema

```bash
# Python 3.11+
python --version

# Node.js 18+ (para frontend)
node --version

# Docker (opcional, para despliegue)
docker --version
```

### Variables de Entorno

Crear archivo `env.list` en la ra√≠z del proyecto:

```bash
# API Keys
GEMINI_API_KEY="tu-api-key-de-gemini"

# MedGemma (Vertex AI)
GCP_MEDGEMMA_ENDPOINT="https://REGION-aiplatform.googleapis.com/v1/projects/PROJECT/locations/REGION/endpoints/ENDPOINT"
GCP_MEDGEMMA_SERVICE_ACCOUNT_KEY='{"type": "service_account", ...}'

# Configuraci√≥n local (alternativa)
LOCAL_MEDGEMMA_URL="http://localhost:1234/v1"
LOCAL_MEDGEMMA_API_KEY="lm-studio"

# Opciones
GENERATE_SPEECH="true"  # Habilitar s√≠ntesis de voz
CACHE_DIR="./cache"     # Directorio de cach√©
FRONTEND_BUILD="frontend/build"  # Directorio de build del frontend
```

### Instalaci√≥n y Ejecuci√≥n

#### **Opci√≥n 1: Desarrollo Local**

```bash
# 1. Clonar repositorio
git clone https://huggingface.co/spaces/google/appoint-ready
cd appoint-ready

# 2. Instalar dependencias Python
python -m venv venv
source venv/bin/activate  # En Windows: venv\Scripts\activate
pip install -r requirements.txt

# 3. Instalar dependencias Frontend
cd frontend
npm install

# 4. Build del Frontend
npm run build
cd ..

# 5. Configurar variables de entorno
# Crear archivo env.list con tus credenciales

# 6. Ejecutar servidor
python app.py

# La aplicaci√≥n estar√° disponible en http://localhost:7860
```

#### **Opci√≥n 2: Docker**

```bash
# 1. Build de la imagen
docker build -t medgemma-demo .

# 2. Ejecutar contenedor
docker run -p 7860:7860 --env-file env.list medgemma-demo

# Acceder en http://localhost:7860
```

#### **Opci√≥n 3: Script Automatizado**

```bash
# El proyecto incluye un script de ejecuci√≥n
chmod +x run_local.sh
./run_local.sh
```

### Estructura del Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Instalar dependencias del sistema
RUN apt-get update && apt-get install -y \
    nodejs npm \
    && rm -rf /var/lib/apt/lists/*

# Copiar archivos
COPY requirements.txt .
COPY frontend/package.json frontend/

# Instalar dependencias Python
RUN pip install --no-cache-dir -r requirements.txt

# Instalar y build frontend
RUN cd frontend && npm install && npm run build

# Copiar c√≥digo
COPY . .

# Exponer puerto
EXPOSE 7860

# Comando de inicio
CMD ["python", "app.py"]
```

---

## üåê Traducci√≥n al Espa√±ol

### Archivos Traducidos

#### **Frontend (React)**

**1. WelcomePage.js**
- T√≠tulo: "Demo de Simulaci√≥n de Entrevista Pre-visita"
- Descripci√≥n completa del sistema
- Descargo de responsabilidad
- Bot√≥n: "Seleccionar Paciente"

**2. PatientBuilder.js**
- Encabezados: "Seleccionar un Paciente", "Explorar una Condici√≥n"
- Etiquetas: "a√±os", "Condici√≥n existente"
- "Registro de Salud Sint√©tico (FHIR)"
- Bot√≥n: "Lanzar simulaci√≥n"

**3. Interview.js**
- "Entrevista Simulada"
- "audio por Gemini TTS"
- "Esperando a que comience la entrevista..."
- "Pensando..."
- "Reporte Generado"
- "Ver Evaluaci√≥n del Reporte"
- "Por favor espera..."
- Descargo de responsabilidad completo
- "Acerca de la Evaluaci√≥n"
- Bot√≥n: "Continuar"

#### **Backend (Python)**

**1. interview_simulator.py**

**Instrucciones del Paciente:**
```python
return f"""
INSTRUCCI√ìN DEL SISTEMA: Antes de que comience la entrevista...

### Tu Persona ###
- **Nombre:** {patient_name}
- **Edad:** {patient["age"]}
- **G√©nero:** {patient["gender"]}

### Escenario ###
Est√°s en casa, participando en una entrevista remota pre-visita...

### Tu Historial M√©dico ###
Tienes un historial conocido de **{patient["existing_condition"]}**...

### Tus S√≠ntomas Actuales ###
As√≠ es como te has estado sintiendo...

### Reglas Cr√≠ticas de Interpretaci√≥n ###
- **Maneja S√≠ntomas Opcionales:** ...
- **Act√∫a como el Paciente:** ...
- **No Adivines:** ...
- **Responde Solo lo que se Pregunta:** ...
"""
```

**Instrucciones del Entrevistador:**
```python
return f"""
INSTRUCCI√ìN DEL SISTEMA: Siempre piensa silenciosamente antes de responder.

### Persona y Objetivo ###
Eres un asistente cl√≠nico. Tu objetivo es entrevistar a un paciente...

### Reglas Cr√≠ticas ###
- **Sin Evaluaciones:** NO est√°s autorizado...
- **Formato de Pregunta:** Haz solo UNA pregunta a la vez...
- **Longitud de Pregunta:** Cada pregunta debe tener 20 palabras o menos...
- **L√≠mite de Preguntas:** Tienes un m√°ximo de 20 preguntas...

### Estrategia de Entrevista ###
- **Razonamiento Cl√≠nico:** ...
- **Diferenciar:** ...
- **Investigar Pistas Cr√≠ticas:** ...
- **Indagaci√≥n Exhaustiva:** ...
- **B√∫squeda de Hechos:** ...

### Procedimiento ###
1. **Iniciar Entrevista:** "Gracias por reservar una cita..."
2. **Realizar Entrevista:** ...
3. **Terminar Entrevista:** "Gracias por responder mis preguntas..."
"""
```

**Instrucciones del Redactor:**
```python
return f"""<rol>
Eres un asistente m√©dico altamente calificado...
</rol>

<tarea>
Tu tarea es generar un reporte de admisi√≥n m√©dica conciso...
</tarea>

<principios_gu√≠a>
1. **Principio de Brevedad**:
   * **Usa Lenguaje Profesional**: ...
   * **Omite Relleno**: ...

2. **Principio de Relevancia Cl√≠nica**:
   * **Prioriza el HPI**: ...
   * **Incluye "Negativos Pertinentes"**: ...
   * **Filtra Historia**: ...
</principios_gu√≠a>

<instrucciones>
1. **Objetivo Primario**: Sintetiza la entrevista y el EHR...
2. **Enfoque de Contenido**:
   * **Preocupaci√≥n Principal**: ...
   * **S√≠ntomas**: ...
   * **Historia Relevante**: ...
3. **Restricciones**:
   * **Solo Informaci√≥n Factual**: ...
   * **Sin Diagn√≥stico o Evaluaci√≥n**: ...
</instrucciones>
"""
```

**2. evaluation.py**
```python
def evaluation_prompt(defacto_condition):
    return f"""
Tu rol es evaluar la utilidad de un reporte pre-visita...

Lista los elementos espec√≠ficos en el texto del reporte...

PLANTILLA DE REPORTE INICIO

<h3 class="helpful">Hechos √ötiles:</h3>

<h3 class="missing">Lo que no se cubri√≥ pero ser√≠a √∫til:</h3>

PLANTILLA DE REPORTE FIN
"""
```

**3. report_template.txt**
```markdown
### Preocupaci√≥n principal:

### Historia de la Enfermedad Presente (HPI):

### Historia M√©dica Relevante (del EHR): 

### Medicamentos (del EHR y entrevista):
```

#### **Datos (JSON)**

**1. patients_and_conditions.json**
```json
{
  "conditions": [
    { "name": "Gripe", "description": "Una enfermedad respiratoria com√∫n..." },
    { "name": "Malaria", "description": "Una enfermedad grave transmitida..." },
    { "name": "Migra√±a", "description": "Un tipo de dolor de cabeza severo..." },
    { "name": "S√≠ndrome de Serotonina", "description": "Una reacci√≥n potencialmente..." }
  ]
}
```

**2. symptoms.json**
```json
{
  "Flu": [
    "Tengo fiebre, me siento caliente y fr√≠o.",
    "Tengo tos.",
    "Me duele la garganta.",
    ...
  ],
  "Migraine": [
    "Tengo un dolor de cabeza muy fuerte...",
    ...
  ],
  "Malaria": [
    "Tengo fiebre alta.",
    "Tengo escalofr√≠os y temblores.",
    ...
  ],
  "Serotonin Syndrome": [
    "Me siento agitado o inquieto.",
    ...
  ]
}
```

### Mapeo de Condiciones

Para mantener compatibilidad con el c√≥digo existente, se implement√≥ un sistema de mapeo:

```python
def get_condition_key(condition_name):
    """Map Spanish condition names to English keys in symptoms.json"""
    condition_mapping = {
        "Gripe": "Flu",
        "Malaria": "Malaria", 
        "Migra√±a": "Migraine",
        "S√≠ndrome de Serotonina": "Serotonin Syndrome"
    }
    return condition_mapping.get(condition_name, condition_name)
```

### Instrucciones de TTS en Espa√±ol

```python
# Para el entrevistador
audio_data, mime_type = synthesize_gemini_tts(
    f"Habla de manera ligeramente optimista y en√©rgica, como un cl√≠nico amigable: {text}",
    INTERVIEWER_VOICE
)

# Para el paciente
audio_data, mime_type = synthesize_gemini_tts(
    f"Di esto a velocidad m√°s r√°pida, usando un tono enfermo: {text}",
    patient_voice
)
```

---

## üìÇ Estructura de Archivos

```
Simulacion/
‚îÇ
‚îú‚îÄ‚îÄ frontend/                          # Frontend React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WelcomePage/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WelcomePage.js     ‚úÖ Traducido
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WelcomePage.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PatientBuilder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PatientBuilder.js  ‚úÖ Traducido
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PatientBuilder.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interview/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interview.js       ‚úÖ Traducido
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Interview.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RolePlayDialogs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RolePlayDialogs.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RolePlayDialogs.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DetailsPopup/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DetailsPopup.js
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ DetailsPopup.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patients_and_conditions.json  ‚úÖ Traducido
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jordan.avif
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alex.avif
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sacha.avif
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jordan_fhir.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alex_fhir.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sacha_fhir.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ package-lock.json
‚îÇ
‚îú‚îÄ‚îÄ backend/                           # Backend Python
‚îÇ   ‚îú‚îÄ‚îÄ app.py                         # Servidor Flask
‚îÇ   ‚îú‚îÄ‚îÄ interview_simulator.py         ‚úÖ Traducido
‚îÇ   ‚îú‚îÄ‚îÄ medgemma.py                    # Cliente MedGemma
‚îÇ   ‚îú‚îÄ‚îÄ gemini.py                      # Cliente Gemini
‚îÇ   ‚îú‚îÄ‚îÄ gemini_tts.py                  # Cliente TTS
‚îÇ   ‚îú‚îÄ‚îÄ local_llm_client.py            ‚úÖ Traducido
‚îÇ   ‚îú‚îÄ‚îÄ evaluation.py                  ‚úÖ Traducido
‚îÇ   ‚îú‚îÄ‚îÄ cache.py                       # Sistema de cach√©
‚îÇ   ‚îî‚îÄ‚îÄ auth.py                        # Autenticaci√≥n GCP
‚îÇ
‚îú‚îÄ‚îÄ data/                              # Datos y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ symptoms.json                  ‚úÖ Traducido
‚îÇ   ‚îî‚îÄ‚îÄ report_template.txt            ‚úÖ Traducido
‚îÇ
‚îú‚îÄ‚îÄ cache/                             # Cach√© persistente
‚îÇ   ‚îî‚îÄ‚îÄ cache.db
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt                   # Dependencias Python
‚îú‚îÄ‚îÄ Dockerfile                         # Dockerfile para despliegue
‚îú‚îÄ‚îÄ env.list                           # Variables de entorno
‚îú‚îÄ‚îÄ run_local.sh                       # Script de ejecuci√≥n
‚îú‚îÄ‚îÄ README.md                          # Documentaci√≥n original
‚îî‚îÄ‚îÄ ARQUITECTURA_Y_TRADUCCION.md      # Este documento

```

### Descripci√≥n de Archivos Principales

| Archivo | Descripci√≥n | Estado |
|---------|-------------|--------|
| `app.py` | Servidor Flask con endpoints REST | ‚úÖ Original |
| `interview_simulator.py` | L√≥gica de simulaci√≥n y generaci√≥n de reportes | ‚úÖ Traducido |
| `medgemma.py` | Cliente para MedGemma (Vertex AI) | ‚úÖ Original |
| `gemini.py` | Cliente para Gemini API | ‚úÖ Original |
| `gemini_tts.py` | Cliente para Gemini TTS | ‚úÖ Original |
| `local_llm_client.py` | Cliente para modelos locales | ‚úÖ Traducido |
| `evaluation.py` | Evaluaci√≥n de reportes | ‚úÖ Traducido |
| `cache.py` | Sistema de cach√© con diskcache | ‚úÖ Original |
| `symptoms.json` | Base de datos de s√≠ntomas | ‚úÖ Traducido |
| `patients_and_conditions.json` | Datos de pacientes | ‚úÖ Traducido |
| `report_template.txt` | Plantilla de reportes | ‚úÖ Traducido |
| `WelcomePage.js` | P√°gina de bienvenida | ‚úÖ Traducido |
| `PatientBuilder.js` | Selector de pacientes | ‚úÖ Traducido |
| `Interview.js` | Interfaz de entrevista | ‚úÖ Traducido |

---

## üéØ Caracter√≠sticas T√©cnicas Avanzadas

### 1. **Sistema de Cach√© Inteligente**

El sistema implementa cach√© persistente para todas las llamadas a APIs de LLM:

```python
from diskcache import Cache

cache = Cache("./cache")

@cache.memoize()
def medgemma_get_text_response(messages, temperature=0.1, max_tokens=4096, ...):
    # Esta funci√≥n se ejecuta solo si no existe en cach√©
    # Los par√°metros sirven como clave de cach√©
    response = requests.post(endpoint, json=payload)
    return response.json()["choices"][0]["message"]["content"]
```

**Beneficios:**
- ‚ö° Respuestas instant√°neas para preguntas repetidas
- üí∞ Reducci√≥n de costos de API
- üå± Menor impacto ambiental
- üîÑ Reproducibilidad de demos

**Gesti√≥n del Cach√©:**
```python
# Estad√≠sticas
print(f"Items en cach√©: {len(cache)}")
print(f"Tama√±o: {cache.volume()} bytes")

# Descarga del cach√©
zip_file = create_cache_zip()
```

### 2. **Streaming en Tiempo Real con SSE**

Server-Sent Events para streaming continuo:

```python
# Backend
def generate():
    for message in stream_interview(patient, condition):
        yield f"data: {message}\n\n"

return Response(stream_with_context(generate()), 
                mimetype="text/event-stream")

# Frontend
const eventSource = new EventSource(url);
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    messageQueue.current.push(data);
    processQueue();
};
```

### 3. **Procesamiento Secuencial de Mensajes**

Cola de mensajes con reproducci√≥n ordenada:

```javascript
const processQueue = () => {
  if (messageQueue.current.length === 0) return;
  
  const nextMessage = messageQueue.current.shift();
  setMessages(prev => [...prev, nextMessage]);
  
  if (nextMessage.audio && isAudioEnabled) {
    // Reproducir audio y continuar al finalizar
    const audio = new Audio(nextMessage.audio);
    audio.onended = () => processQueue();
    audio.play();
  } else {
    // Esperar tiempo fijo y continuar
    setTimeout(processQueue, waitTime);
  }
};
```

### 4. **Generaci√≥n de Diff Visual**

Algoritmo para mostrar cambios incrementales en el reporte:

```javascript
const getDiffReport = () => {
  // Tokenizar HTML
  const tokenizeHTML = (html) => html.match(/(<[^>]+>|[^<]+)/g) || [];
  const tokensPrev = tokenizeHTML(prevReport);
  const tokensCurrent = tokenizeHTML(currentReport);
  
  // Diff a nivel de tokens
  const diffParts = diffArrays(tokensPrev, tokensCurrent);
  
  let result = "";
  for (let i = 0; i < diffParts.length; i++) {
    // Diff interno de palabras para cambios
    if (diffParts[i].removed && i + 1 < diffParts.length && diffParts[i + 1].added) {
      const innerDiff = diffWords(diffParts[i].value.join(""), diffParts[i + 1].value.join(""));
      result += innerDiff.map(part => {
        if (part.added) return `<span class="add">${part.value}</span>`;
        if (part.removed) return `<span class="remove">${part.value}</span>`;
        return part.value;
      }).join("");
      i++; // Skip next
      continue;
    }
    
    if (diffParts[i].added) {
      result += `<span class="add">${diffParts[i].value.join("")}</span>`;
    } else if (diffParts[i].removed) {
      result += `<span class="remove">${diffParts[i].value.join("")}</span>`;
    } else {
      result += diffParts[i].value.join("");
    }
  }
  return result;
};
```

### 5. **S√≠ntesis de Voz Avanzada**

Conversi√≥n de audio con m√∫ltiples formatos:

```python
def synthesize_gemini_tts(text, voice_name):
    # Generar audio con Gemini
    response = model.generate_content(text, generation_config)
    audio_data = response.candidates[0].content.parts[0].inline_data.data
    mime_type = response.candidates[0].content.parts[0].inline_data.mime_type
    
    # Convertir a WAV si es necesario
    if mime_type in ["audio/L16", "audio/L24"]:
        audio_data = convert_to_wav(audio_data, mime_type)
        mime_type = "audio/wav"
    
    # Comprimir a MP3
    audio_segment = AudioSegment.from_file(io.BytesIO(audio_data), format="wav")
    mp3_buffer = io.BytesIO()
    audio_segment.export(mp3_buffer, format="mp3")
    
    return mp3_buffer.getvalue(), "audio/mpeg"
```

### 6. **Gesti√≥n de Registros FHIR**

Integraci√≥n con est√°ndares de salud:

```python
def read_fhir_json(patient):
    with open(patient["fhirFile"], 'r') as f:
        return json.load(f)

def get_ehr_summary_per_patient(patient_name):
    patient = get_patient(patient_name)
    if patient.get("ehr_summary"):
        return patient["ehr_summary"]
    
    # Resumir FHIR con MedGemma
    ehr_summary = local_medgemma_get_text_response([
        {
            "role": "system",
            "content": f"Eres un asistente m√©dico resumiendo los registros EHR (FHIR)..."
        },
        {
            "role": "user",
            "content": json.dumps(read_fhir_json(patient))
        }
    ])
    
    patient["ehr_summary"] = ehr_summary
    return ehr_summary
```

---

## üîß Soluci√≥n de Problemas

### Problema: Error de permisos de cach√©

```
PermissionError: Cache directory "/cache" does not exist and could not be created
```

**Soluci√≥n:**
```python
# En cache.py, cambiar:
cache_dir = os.environ.get("CACHE_DIR", "./cache")  # En lugar de "/cache"
os.makedirs(cache_dir, exist_ok=True)
cache = Cache(cache_dir)
```

### Problema: Modelos locales no responden

**Soluci√≥n:**
1. Verificar que LM Studio est√© ejecut√°ndose en `http://localhost:1234`
2. Configurar variables de entorno:
```bash
LOCAL_MEDGEMMA_URL="http://localhost:1234/v1"
LOCAL_MEDGEMMA_API_KEY="lm-studio"
```

### Problema: Audio no se genera

**Soluci√≥n:**
1. Verificar variable `GENERATE_SPEECH="true"` en `env.list`
2. Verificar API key de Gemini
3. Revisar logs para errores de TTS

### Problema: Frontend no encuentra assets

**Soluci√≥n:**
```bash
# Reconstruir frontend
cd frontend
npm run build
cd ..

# Verificar variable de entorno
export FRONTEND_BUILD="frontend/build"
```

---

## üìä M√©tricas y Rendimiento

### Tiempos Promedio

| Operaci√≥n | Sin Cach√© | Con Cach√© |
|-----------|-----------|-----------|
| Pregunta MedGemma | 2-5s | <0.1s |
| Respuesta Gemini | 1-3s | <0.1s |
| Actualizaci√≥n Reporte | 3-6s | <0.1s |
| S√≠ntesis TTS (por mensaje) | 1-2s | <0.1s |
| Evaluaci√≥n Final | 5-10s | <0.1s |
| **Entrevista Completa** | **~120s** | **~15s** |

### Consumo de Tokens (Promedio por Entrevista)

| Modelo | Entrada | Salida | Total |
|--------|---------|--------|-------|
| MedGemma (Preguntas) | 5,000 | 2,000 | 7,000 |
| MedGemma (Reportes) | 15,000 | 3,000 | 18,000 |
| MedGemma (Evaluaci√≥n) | 8,000 | 2,000 | 10,000 |
| Gemini (Respuestas) | 3,000 | 1,500 | 4,500 |
| **Total por Entrevista** | | | **~40,000** |

### Tama√±o del Cach√©

- **Por entrevista completa**: ~2 MB
- **100 entrevistas**: ~200 MB
- **Compresi√≥n ZIP**: ~50 MB (para 100 entrevistas)

---

## üöÄ Pr√≥ximas Mejoras

### Funcionalidades Planeadas

1. **Soporte Multi-idioma Completo**
   - Detecci√≥n autom√°tica de idioma
   - Traducci√≥n din√°mica de interfaces
   - Modelos multiling√ºes

2. **An√°lisis Avanzado**
   - M√©tricas de calidad del reporte
   - An√°lisis de sentimientos
   - Detecci√≥n de patrones cl√≠nicos

3. **Integraci√≥n con EHR Reales**
   - Conectores para sistemas EHR comunes
   - API para importar historiales
   - Sincronizaci√≥n bidireccional

4. **Personalizaci√≥n del Modelo**
   - Fine-tuning de MedGemma para especialidades
   - Adaptaci√≥n a protocolos institucionales
   - Base de conocimiento customizable

5. **Caracter√≠sticas de Producci√≥n**
   - Autenticaci√≥n y autorizaci√≥n
   - Audit logs
   - Encriptaci√≥n end-to-end
   - Cumplimiento HIPAA

---

## üìù Licencia

```
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

---

## üìß Contacto y Soporte

- **Proyecto**: [Health AI Developer Foundations (HAI-DEF)](https://developers.google.com/health-ai-developer-foundations?referral=appoint-ready)
- **Repositorio**: [HuggingFace Space](https://huggingface.co/spaces/google/appoint-ready)
- **Consultas T√©cnicas**: [@lirony](https://huggingface.co/lirony)
- **Prensa**: press@google.com

---

## ‚ö†Ô∏è Descargo de Responsabilidad

Esta demostraci√≥n es solo para fines ilustrativos de las capacidades b√°sicas de MedGemma. No representa un producto terminado o aprobado, no est√° destinada a diagnosticar o sugerir tratamiento de ninguna enfermedad o condici√≥n, y no debe usarse para consejo m√©dico.

Este no es un producto oficialmente soportado por Google. Este proyecto no es elegible para el [Programa de Recompensas por Vulnerabilidades de Software de C√≥digo Abierto de Google](https://bughunters.google.com/open-source-security).

---

**Documentaci√≥n creada por**: Asistente de IA Claude  
**Fecha**: Octubre 2025  
**Versi√≥n**: 1.0  
**Estado**: ‚úÖ Completo - UI y modelos traducidos al espa√±ol

